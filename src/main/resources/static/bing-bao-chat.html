<!DOCTYPE html>
<html lang="en" xmlns:x-on="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <title>冰寶</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
  <link href="https://fonts.googleapis.com/css?family=Raleway|Ubuntu&display=swap">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body x-data="loadData()" x-init="init()">
  <div class="fixed bottom-0 right-0 mb-4 mr-4">
    <button x-on:click="connect($event)" id="open-chat" class="bg-black text-white rounded-full hover:bg-gray-800 transition duration-300 flex items-center justify-center w-16 h-16">
      <i class="fas fa-comments text-xl"></i>
    </button>
  </div>
  <div id="chat-container" class="hidden fixed bottom-[6rem] right-4 w-96">
    <div class="bg-white shadow-md rounded-lg max-w-lg w-full">
      <div class="p-4 border-b bg-black text-white rounded-t-lg flex justify-between items-center">
        <p class="text-lg font-semibold">冰寶小助手</p>
        <button x-on:click="disconnect()" id="close-chat" class="text-gray-300 hover:text-gray-400 focus:outline-none focus:text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <template x-if="memberId != undefined">
        <div id="chatbox" class="p-4 h-80 overflow-y-auto">
          <!-- Chat messages will be displayed here -->
          <template x-for="(chat, index) in chatData" :key="index">
            <div :class="index % 2 === 0 ? 'text-right' : 'text-left'" class="mb-2">
              <!-- 偶數位置的訊息使用藍色背景 -->
              <p x-html="chat.text"
                 :class="index % 2 === 0 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                 class="rounded-lg py-2 px-4 inline-block">
              </p>
            </div>
          </template>
        </div>
        <div class="p-4 border-t flex">
          <textarea id="userText" x-model="userText" placeholder="請輸入訊息" class="w-full px-3 py-2 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          <button id="sendBtn" x-on:click="sendMessage($event)" class="bg-black text-white px-4 py-2 rounded-r-md hover:bg-blue-600 transition duration-300"><i class="far fa-paper-plane"></i></button>
        </div>
      </template>
      <template x-if="memberId == undefined">
        <div id="chatbox" class="flex justify-center items-center p-4 h-80 overflow-y-auto bg-gray-200">
          <a href="https://gurula.cc/chatbot/login?type=google&project=badminton" class="bg-black text-white py-2 px-4 rounded-md">
            Google登入
          </a>
          <br>
          <a href="https://gurula.cc/chatbot/login?type=line&project=badminton" class="bg-black text-white py-2 px-4 rounded-md">
            Line登入
          </a>
        </div>
      </template>
    </div>
  </div>
  <script src="js/alpine.2.8.2.min.js"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/marked.min.js"></script>
  <script src="js/sockjs.min.js"></script>
  <script src="js/stomp.min.js"></script>
  <script>

    function loadData() {
      return {
        chatData: [],
        channel: "bingBao",
        chatChannel: "",
        memberId: "",
        userText: "",

        init() {
          let _this = this;

          //從cookie中取出memberId
          this.memberId = this.getCookie("MEMBER_ID");
          console.log(this.memberId);

          let isChatboxOpen = false; // 預設關閉
          $("#chat-container").addClass("hidden");

          // 切換 chatbox
          function toggleChatbox() {
            $("#chat-container").toggleClass("hidden");
            isChatboxOpen = !isChatboxOpen;
          }

          // 綁定開啟/關閉按鈕事件
          $("#open-chat").on("click", toggleChatbox);
          $("#close-chat").on("click", toggleChatbox);

          if(this.memberId == undefined) return;

        },
        scrollToBottom (){
          let chatbox = $("#chatbox")[0];
          $("#chatbox").scrollTop(chatbox.scrollHeight);
        },
        connect(event) {
          let _this = this;
          if(this.memberId == undefined) return;
          if(this.chatChannel == "") {
            $.ajax({
              url: "ai/getChatChannel/" + this.channel + "/" + this.memberId,
              type: "get",
              dataType: "json",
              contentType: "application/json; charset=utf-8",
              success: function (response) {
                if (response.code == "C000"){
                  _this.chatChannel = response.data;
                  console.log(_this.chatChannel);
                  _this.loadChatHistory();
                  _this.initializeWebSocketConnection(event);
                } else {
                  return;
                }
              },
            });
          } else {
            this.initializeWebSocketConnection(event);
          }
          event.preventDefault();
        },
        initializeWebSocketConnection(event) {
          if (this.memberId) {
            var socket = new SockJS('chatroom');
            stompClient = Stomp.over(socket);

            stompClient.heartbeat.outgoing = 3000; // 每 3 秒發送一次心跳
            stompClient.heartbeat.incoming = 3000; // 每 3 秒接收心跳

            stompClient.connect({}, (frame) => {
              console.log('連接成功: ' + frame);
              this.onConnected();
            }, (error) => {
              console.error('連接失敗: ' + error);
              setTimeout(() => { // 重試連接
                this.initializeWebSocketConnection(event);
              }, 500); // 0.5秒後重試
            });
          } else {
            popHint();
          }
        },
        onConnected (){
          // 訂閱
          stompClient.subscribe(`/${this.channel}/${this.memberId}/${this.chatChannel}`, this.onMessageReceived.bind(this));

  <!--        stompClient.send("/app/join", {}, JSON.stringify({-->
  <!--            memberId: this.memberId-->
  <!--        }))-->

          console.log("已成功訂閱聊天頻道");
        },
        sendMessage(event) {
          if (stompClient) {
            if (this.userText.trim() === '') return;

            this.chatData.push({ text: this.userText });
            let chatMessage = {
              memberId: this.memberId,
              query: this.userText,
              chatChannel: this.chatChannel
            };

            stompClient.send("/ai/bingBao/chat", {}, JSON.stringify(chatMessage));
            this.userText = '';
          }
          event.preventDefault();
        },
        onMessageReceived(payload) {
          console.log("回覆訊息：" + payload.body)
          this.chatData.push({ text: marked.parse(payload.body) });
        },
        disconnect() {
          let _this = this;
          if(this.memberId == "") return;
          if (stompClient) {
            stompClient.disconnect(function() {
              console.log('斷開連接成功');
            });
          }
        },
        getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        },
        loadChatHistory() {
            let _this = this;
            let data = {
                projectName: 'BingBao',
                memberId: this.memberId,
                chatChannel: this.chatChannel
            };

            $.ajax({
                url: "ai/chatHistory",
                type: "post",
                dataType: "json",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    _this.chatData = response;
                    _this.chatData = _this.chatData.map(chat => {
                        return {
                            ...chat,
                            text: marked.parse(chat.text) // 將 Markdown 轉換為 HTML
                        };
                    });
                    console.log(_this.chatData);
                    _this.scrollToBottom();
                },
            });
        },
      }
    }

  </script>
</body>
</html>
